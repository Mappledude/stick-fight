// Firestore security rules for Stick Fight
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function isAuthed() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthed() &&
        (request.auth.token.admin == true || request.auth.token.stickfightAdmin == true);
    }

    function roomWriteHasOnlyAllowedFields() {
      return request.resource.data.keys().hasOnly([
        'code',
        'active',
        'status',
        'createdAt',
        'updatedAt',
        'lastActivityAt',
        'maxPlayers',
        'hostPeerId',
        'hostUid',
        'playerCount'
      ]);
    }

    function roomUpdateHasOnlyAllowedChanges() {
      return resource.data.diff(request.resource.data).changedKeys().hasOnly([
        'updatedAt',
        'lastActivityAt',
        'playerCount',
        'hostPeerId',
        'status',
        'active',
        'maxPlayers'
      ]);
    }

    function isRoomHost(roomId) {
      return isAuthed() &&
        (resource.data.hostUid == request.auth.uid ||
          request.resource.data.hostUid == request.auth.uid);
    }

    match /settings/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /players/{codeWord} {
      allow read: if true;
      allow write: if false;
    }

    match /rooms/{roomId} {
      allow read: if true;

      allow create: if isAuthed() &&
        roomWriteHasOnlyAllowedFields() &&
        request.resource.data.code == roomId &&
        request.resource.data.hostUid == request.auth.uid;

      allow update: if isAuthed() &&
        roomWriteHasOnlyAllowedFields() &&
        request.resource.data.code == roomId &&
        request.resource.data.createdAt == resource.data.createdAt &&
        request.resource.data.hostUid == resource.data.hostUid &&
        (
          isAdmin() ||
          (isRoomHost(roomId) && roomUpdateHasOnlyAllowedChanges())
        );

      allow delete: if isAdmin();

      match /players/{uid} {
        allow read: if true;

        allow create, update: if isAuthed() &&
          request.auth.uid == uid &&
          request.resource.data.uid == uid;

        allow delete: if isAuthed() && request.auth.uid == uid;
      }

      match /signals/{peerId} {
        allow read, write: if isAuthed();
      }
    }
  }
}
